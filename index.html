<!DOCTYPE HTML>
<html>
<head>
  <title>Click Map</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>

  <style>
    body, html {
      height: 100%;
      overflow-y: hidden;
    }

    #clickMap {
      position: relative;
      margin-left: 10%;
      width: 80%;
    }

    .image {
      width: 100%;
      height: auto;
      -webkit-user-select: none;  /* Chrome all / Safari all */
      -moz-user-select: none;     /* Firefox all */
      -ms-user-select: none;      /* IE 10+ */
      user-select: none;          /* Likely future */
    }

    .svgDiv {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
    }

    .event {
      fill-opacity: 0.75;
      stroke: black;
      stroke-opacity: 0.75;
    }

    .background {
      visibility: hidden;
      pointer-events: all;
    }
  </style>
</head>

<body>

<div class="page-header text-center">
  <h1>Click Map</h1>
</div>
<div class="container-fluid">
  <div class="row">
    <div class="col-md-2">
      <div class="custom-file mb-3">
        <input id="rosterUpload" type="file" class="custom-file-input"></input>
        <label class="custom-file-label" for="rosterUpload">Upload Roster</label>
      </div>
      <div class="form-group">
        <label for="playerSelect">Player</label>
        <select id="playerSelect" class="form-control"></select>
      </div>
      <div class="form-group">
        <label for="pointTypeButtons">Points</label>
        <div id="pointTypeButtons"></div>
      </div>
      <div class="form-group">
        <label for="shotTypeButtons">Shot Type</label><br>
        <div id="shotTypeButtons" class="btn-group"></div>
      </div>
      <div class="form-group">
        <label for="filenameInput">Output Filename</label>
        <input id="filenameInput" type="text" class="form-control" value="Click Map.csv">
      </div>
      <button id="downloadButton" class="btn btn-primary">Download Data</button>
    </div>
    <div class="col-md-8">
      <div class="panel panel-default">
        <div id="clickMap">
          <img src="/images/basketballCourt.png" class="image" draggable="false" />
          <div class="svgDiv">
            <svg width="100%" height="100%">
              <rect class="background" width="100%" height="100%" />
            </svg>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <button id="clearButton" class="btn btn-primary">Clear All</button>
    </div>
  </div>
</div>

<script type="text/javascript">

// Set roster filename here
var rosterFileName = "/rosters/DavidsonRoster.txt";

// Current player
var player;

// Add point types here
var pointTypes = ["3 pts", "2 pts", "0 (missed 3)", "0 (missed 2)"],
    pointType = pointTypes[0];

// Add shot types here
var shotTypes = ["layup/dunk", "dribble jumper", "catch & shoot", "runner/floater", "post move", "remove"],
    shotType = shotTypes[0];

// Set up color and shape
var eventColor = d3.scaleOrdinal()
    .domain(pointTypes)
    .range(d3.schemeCategory10);

var eventShape = d3.scaleOrdinal()
    .domain(shotTypes)
    .range(d3.symbols);

var shapeSize = 10;

d3.text(rosterFileName, function(error, rosterData) {
  if (error) {
    console.log(error);
  }

  var roster = d3.tsvParseRows(rosterData, function(d) {
    return {
      number: +d[0],
      name: d[1]
    };
  });

  if (roster.length > 0) player = roster[0];

  createControls();
  createClickMap();

  function createControls() {
    // Get player object from roster based on name
    function getPlayer(name) {
      return roster[roster.map(function(d) { return d.name; }).indexOf(name)];
    }

    // Drop down for players
    d3.select("#playerSelect")
        .on("change", function(d) {
          player = getPlayer(this.value);
        })
        .selectAll("option")
        .data(roster)
      .enter().append("option")
        .attr("value", function(d) { return d.name; })
        .text(function(d) { return "#" + d.number + " " + d.name; });

    // Radio buttons for points
    var pointEnter = d3.select("#pointTypeButtons").selectAll(".form-check")
        .data(pointTypes)
      .enter().append("div")
        .attr("class", "form-check pl-4")
        .style("background-color", function(d) {
          var c = d3.color(eventColor(d));
          c.opacity = 0.75;
          return c;
        })
        .style("border", "1px solid rgba(0, 0, 0, 0.75")
        .style("border-radius", "5px")
        .on("click", function(d) {
          pointType = d;
        });

    pointEnter.append("input")
        .attr("type", "radio")
        .attr("class", "form-check-input")
        .attr("name", "pointTypeRadios")
        .attr("id", function(d) { return d + "_radio"; })
        .attr("value", function(d) { return d; })
        .property("defaultChecked", function(d) { return d === pointType; });

    pointEnter.append("label")
        .text(function(d) { return d; })
        .attr("class", "form-check-label")
        .attr("for", function(d) { return d + "_radio"; });

    // Radio buttons for shot types
    var shotEnter = d3.select("#shotTypeButtons").selectAll(".radio")
        .data(shotTypes)
      .enter().append("div")
        .attr("class", "radio")
        .on("click", function(d) {
          shotType = d;
        })
      .append("label");

    shotEnter.append("input")
        .attr("type", "radio")
        .attr("name", "shotTypeRadio")
        .attr("value", function(d) { return d; })
        .property("defaultChecked", function(d) { return d === shotType; });

    shotEnter.append("span")
        .text(function(d) { return d; });

    var w = shapeSize * 2,
        h = shapeSize * 2;

    shotEnter.filter(function(d) {
      return d !== "remove";
    }).append("svg")
        .attr("width", w)
        .attr("height", h)
      .append("g")
        .attr("class", "event")
        .attr("transform", function(d) {
          return "translate(" + (w / 2) + "," + (h / 2) + ")";
        })
      .append("path")
        .attr("d", function(d) {
          return getShape(d)();
        });

    // Download button
    d3.select("#downloadButton").on("click", function() {
      var data = [],
          columns = [];

      // Get event data
      d3.select("#clickMap").selectAll(".event").each(function(d, i) {
        if (i === 0) {
          // Get columns from first event
          columns = d3.keys(d);
          data = columns.join(",") + "\n";
        }

        // Add event data
        data += columns.map(function(column) {
          return d[column];
        }).join(",") + "\n";
      });

      // Create temporary download link for data
      var a = window.document.createElement('a');
      a.href = window.URL.createObjectURL(new Blob([data], {type: 'text/csv'}));
      a.download = d3.select("#filenameInput").property("value");

      // Append anchor to body
      document.body.appendChild(a)
      a.click();

      // Remove anchor from body
      document.body.removeChild(a)
    });

    // Clear button
    d3.select("#clearButton").on("click", function() {
      d3.select("#clickMap").selectAll(".event").remove();
    });
  }

  function createClickMap() {
    d3.select("#clickMap").select("img").on("click", function() {
      d3.event.preventDefault();
    });

    // Select the svg element
    var svg = d3.select("#clickMap").select("svg");

    // Get the width and height
    var width = parseInt(svg.style("width"), 10),
        height = parseInt(svg.style("height"), 10);

    // Receive click events from background
    svg.on("click", function() {
      if (shotType === "remove") return;

      var x = d3.mouse(this)[0],
          y = d3.mouse(this)[1];

      // Set the data for this event
      var data = {
        x: x,
        y: y,
        xNorm: x / width,
        yNorm: y / height,
        playerName: player.name,
        pointType: pointType,
        shotType: shotType
      };

      // Draw the event
      svg.append("g").datum(data)
          .attr("class", "event")
          .attr("transform", function(d) {
            return "translate(" + d.x + "," + d.y + ")";
          })
          .on("click", function() {
            if (shotType === "remove") {
              d3.event.stopPropagation();

              d3.select(this).remove();

              return;
            }
          })
        .append("path")
          .attr("d", function(d) {
            return getShape(d.shotType)();
          })
          .style("fill", function(d) {
            return eventColor(d.pointType);
          });
    });
  }
});

function getShape(shotType) {
  return d3.symbol()
    .type(eventShape(shotType))
    .size(shapeSize * shapeSize);
}

</script>
</body>
</html>
