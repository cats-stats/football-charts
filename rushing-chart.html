<!DOCTYPE HTML>
<html>

<head>
  <title>Rushing Chart</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,300;0,700;1,700&display=swap"
    rel="stylesheet">

  <style>
    body,
    html {
      height: 100%;
      overflow-y: hidden;
    }

    .mainDiv {
      margin-left: 5%;
      width: 90%;
    }

    #clickMap {
      position: relative;
    }

    .ownHalf {
      background-color: #fddbc7;
    }

    .opponentHalf {
      background-color: #d1e5f0;
    }

    .image {
      width: 100%;
      height: auto;
      -webkit-user-select: none;
      /* Chrome all / Safari all */
      -moz-user-select: none;
      /* Firefox all */
      -ms-user-select: none;
      /* IE 10+ */
      user-select: none;
      /* Likely future */
    }

    .svgDiv {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
    }

    .event {
      fill-opacity: 0.75;
      stroke: black;
      stroke-opacity: 0.75;
    }

    .background {
      visibility: hidden;
      pointer-events: all;
    }
  </style>
</head>

<body>

  <div class="text-center mb-5">
    <h1 class="display-1">Football - Defense Chart</h1>
  </div>
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-3">
        <div class="custom-file mb-3">
          <input id="rosterUpload" type="file" class="custom-file-input"></input>
          <label class="custom-file-label" for="rosterUpload">Upload Roster</label>
        </div>
        <div class="form-group">
          <label for="playerSelect">Player</label>
          <select id="playerSelect" class="form-control"></select>
        </div>
        <div class="form-group">
          <label for="playTypeButtons">Play</label>
          <div id="playTypeButtons"></div>
        </div>
        <div class="form-group">
          <label for="yardageTypeButtons">Yardage</label>
          <div id="yardageTypeButtons"></div>
          <button id="clearButton" class="btn btn-primary">Clear All</button>
        </div>
        <div class="form-group">
          <label for="filenameInput">Output Filename</label>
          <input id="filenameInput" type="text" class="form-control mb-1" value="Click Map.csv">
          <button id="downloadButton" class="btn btn-primary">Download Data</button>
        </div>
      </div>
      <div class="col-md-9">
        <div class="mainDiv">
          <div class="row text-center">
            <div class="col-md-5">
              <h2 class="leftHalf ownHalf">Own</h2>
            </div>
            <div class="col-md-2"><button id="switchButton" class="btn btn-primary">Switch</button></div>
            <div class="col-md-5">
              <h2 class="rightHalf opponentHalf">Opponent</h2>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <div id="clickMap">
                <img src="./images/football.png" class="image" draggable="false" />
                <div class="svgDiv">
                  <svg width="100%" height="100%">
                    <rect class="background" width="100%" height="100%" />
                  </svg>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="text-right small">
      <div>Author: David Borland, RENCI, UNC-Chapel Hill</div>
      <div><a href="https://github.com/davidborland/ClickMap">GitHub repository</a></div>
    </div>
  </div>

  <script type="text/javascript">

    // Current player
    let player = null;

    // Add play types here
    const playTypes = ["Rushing tackle", "Rushing missed tackle", "Reception tackle", "Reception missed tackle", "Interception", "Interception dropped"];
    let playType = playTypes[0];

    // Add yardage types here
    const yardageTypes = ["0-5", "6-10", "11-15", "16-20", "> 20"];
    let yardageType = yardageTypes[0];

    // Set up color and shape
    const eventColor = d3.scaleOrdinal()
      .domain(playTypes)
      .range(d3.schemeCategory10);

    const eventShape = d3.scaleOrdinal()
      .domain(yardageTypes)
      .range(d3.symbols);

    const shapeSize = 10;

    let ownLeft = true;

    // Roster
    let roster = [];
    d3.select("#rosterUpload").on("change", function () {
      if (this.files.length < 1) return;

      const file = this.files[0];

      if (file.type && file.type !== "text/plain") {
        alert("File is not a text file");
        return;
      }

      const reader = new FileReader();
      reader.addEventListener("load", event => {
        const data = event.target.result;

        roster = d3.tsvParseRows(data, d => {
          return {
            number: +d[0],
            name: d[1]
          };
        });

        if (roster.length > 0) player = roster[0];

        createControls();
        createClickMap();
      });
      reader.readAsText(file);
    });

    createControls();
    createClickMap();

    function createControls() {
      // Get player object from roster based on name
      const getPlayer = name => roster[roster.map(d => d.name).indexOf(name)];

      // Drop down for players
      const playerOption = d3.select("#playerSelect")
        .property("disabled", roster.length === 0)
        .on("change", function () {
          player = getPlayer(this.value);

          updateEvents();
        })
        .selectAll("option")
        .data(roster);

      playerOption.enter().append("option")
        .attr("value", d => d.name)
        .text(d => "#" + d.number + " " + d.name);

      playerOption.exit().remove();

      // Radio buttons for plays
      const playEnter = d3.select("#playTypeButtons").selectAll(".form-check")
        .data(playTypes)
        .enter().append("div")
        .attr("class", "form-check pl-4 mb-1")
        .style("background-color", d => {
          const c = d3.color(eventColor(d));
          c.opacity = 0.75;
          return c;
        })
        .style("border", "1px solid rgba(0, 0, 0, 0.75")
        .style("border-radius", "5px")
        .on("click", d => playType = d);

      playEnter.append("input")
        .attr("type", "radio")
        .attr("class", "form-check-input")
        .attr("name", "playTypeRadio")
        .attr("id", d => d + "_radio")
        .attr("value", d => d)
        .property("defaultChecked", d => d === playType);

      playEnter.append("label")
        .text(d => d)
        .attr("class", "form-check-label")
        .attr("for", d => d + "_radio");

      // Radio buttons for yardage types
      const yardageEnter = d3.select("#yardageTypeButtons").selectAll(".form-check")
        .data(yardageTypes)
        .enter().append("div")
        .attr("class", "form-check")
        .on("click", d => yardageType = d);

      yardageEnter.append("input")
        .attr("type", "radio")
        .attr("class", "form-check-input")
        .attr("name", "yardageTypeRadio")
        .attr("id", d => d + "_radio")
        .attr("value", d => d)
        .property("defaultChecked", d => d === yardageType);

      yardageEnter.append("label")
        .text(d => d)
        .attr("class", "form-check-label mr-1")
        .attr("for", d => d + "_radio")
        .style("vertical-align", "20%");

      const w = shapeSize * 2;
      const h = shapeSize * 2;

      yardageEnter.filter(d => d !== "remove").append("svg")
        .attr("width", w)
        .attr("height", h)
        .append("g")
        .attr("class", "event")
        .attr("transform", d => "translate(" + (w / 2) + "," + (h / 2) + ")")
        .append("path")
        .attr("d", d => getShape(d)());

      // Download button
      d3.select("#downloadButton").on("click", () => {
        let data = [];
        let columns = [];

        // Get event data
        d3.select("#clickMap").selectAll(".event").each((d, i) => {
          if (i === 0) {
            // Get columns from first event
            columns = d3.keys(d);
            data = columns.join(",") + "\n";
          }

          // Add event data
          data += columns.map(column => d[column]).join(",") + "\n";
        });

        // Create temporary download link for data
        const a = window.document.createElement("a");
        a.href = window.URL.createObjectURL(new Blob([data], { type: "text/csv" }));
        a.download = d3.select("#filenameInput").property("value");

        // Append anchor to body
        document.body.appendChild(a)
        a.click();

        // Remove anchor from body
        document.body.removeChild(a)
      });

      // Clear button
      d3.select("#clearButton").on("click", () => {
        d3.select("#clickMap").selectAll(".event").remove();
      });

      // Switch button
      d3.select("#switchButton").on("click", () => {
        ownLeft = !ownLeft;

        d3.select(".leftHalf")
          .classed("ownHalf", ownLeft)
          .classed("opponentHalf", !ownLeft)
          .text(ownLeft ? "Own" : "Opponent");

        d3.select(".rightHalf")
          .classed("ownHalf", !ownLeft)
          .classed("opponentHalf", ownLeft)
          .text(ownLeft ? "Opponent" : "Own");

        updateEvents();
      });
    }

    function updateEvents() {
      // Select the svg element
      const svg = d3.select("#clickMap").select("svg");

      // Get the width and height
      const width = parseInt(svg.style("width"), 10);
      const height = parseInt(svg.style("height"), 10);

      svg.selectAll(".event")
        .attr("transform", d => eventTransform(d, width, height));
    }

    function createClickMap() {
      d3.select("#clickMap").select("img").on("click", () => {
        d3.event.preventDefault();
      });

      // Select the svg element
      const svg = d3.select("#clickMap").select("svg");

      // Receive click events from background
      svg.on("click", function () {
        if (!player) return;

        if (yardageType === "remove") return;

        // Get the width and height
        const width = parseInt(svg.style("width"), 10);
        const height = parseInt(svg.style("height"), 10);

        // Store x in own coordinate system
        let x = d3.mouse(this)[0];
        if (!ownLeft) x = width - x;

        const y = d3.mouse(this)[1];

        // Set the data for this event
        const data = {
          x: x,
          y: y,
          xNorm: x / width,
          yNorm: y / height,
          playerName: player.name,
          playerNumber: player.number,
          playType: playType,
          yardageType: yardageType
        };

        // Draw the event
        const g = svg.append("g").datum(data)
          .attr("class", "event")
          .attr("transform", d => eventTransform(d, width, height))
          .on("click", function () {
            if (yardageType === "remove") {
              d3.event.stopPropagation();

              d3.select(this).remove();

              return;
            }
          });

        g.append("path")
          .attr("d", d => getShape(d.yardageType)())
          .style("fill", d => eventColor(d.playType));

        g.append("title")
          .text(d => "#" + d.playerNumber + " " + d.playerName);
      });
    }

    function getShape(yardageType) {
      return d3.symbol()
        .type(eventShape(yardageType))
        .size(shapeSize * shapeSize);
    }

    function eventTransform(d, width, height) {
      let x = d.xNorm * width;
      if (!ownLeft) x = width - x;

      const y = d.yNorm * height;

      const scale = d.playerName === player.name ? 1 : 0.5;

      return "translate(" + x + "," + y + ")scale(" + scale + ")";
    }

  </script>
</body>

</html>